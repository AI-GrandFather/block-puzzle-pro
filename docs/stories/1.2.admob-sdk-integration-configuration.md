# Story 1.2: AdMob SDK Integration and Configuration

## Status
Draft

## Story
**As a** developer,
**I want** to integrate Google AdMob SDK with proper configuration,
**so that** I can serve rewarded video ads to players when they choose.

## Acceptance Criteria
1. AdMob SDK (2025 version) integrated with proper iOS permissions and configuration
2. Test ad units configured for development and testing phases
3. Production ad units ready for App Store deployment
4. Ad loading happens in background without blocking gameplay
5. Error handling for network failures and ad unavailability
6. Compliance with iOS 18.6.2 App Tracking Transparency requirements

## Tasks / Subtasks
- [ ] Task 1: AdMob SDK Integration (AC: 1)
  - [ ] Add AdMob SDK to Xcode project via Swift Package Manager
  - [ ] Import GoogleMobileAds framework in relevant files
  - [ ] Configure AdMob App ID in Info.plist
  - [ ] Add required iOS permissions for ad serving
  - [ ] Initialize AdMob SDK in app launch
- [ ] Task 2: Test Ad Units Configuration (AC: 2)
  - [ ] Configure test rewarded video ad unit for development
  - [ ] Use Google's test ad unit ID: `ca-app-pub-3940256099942544/1712485313`
  - [ ] Implement basic ad loading logic with test units
  - [ ] Test ad loading and display on simulator/device
- [ ] Task 3: Production Ad Units Setup (AC: 3)
  - [ ] Create configuration system for dev/production ad unit IDs
  - [ ] Set up build configuration for production ad units
  - [ ] Document production ad unit IDs for deployment
  - [ ] Implement ad unit ID switching based on build configuration
- [ ] Task 4: Background Ad Loading (AC: 4)
  - [ ] Implement asynchronous ad loading to prevent UI blocking
  - [ ] Create ad loading queue system
  - [ ] Preload ads in background when appropriate
  - [ ] Ensure game performance remains at 60fps during ad operations
- [ ] Task 5: Error Handling Implementation (AC: 5)
  - [ ] Handle network connection failures gracefully
  - [ ] Implement fallback behavior when ads are unavailable
  - [ ] Add proper logging for ad loading failures using os_log
  - [ ] Create user-friendly error messages for ad failures
- [ ] Task 6: App Tracking Transparency Compliance (AC: 6)
  - [ ] Add App Tracking Transparency usage description to Info.plist
  - [ ] Implement ATT permission request flow
  - [ ] Handle user consent choices appropriately
  - [ ] Ensure ads work correctly with/without tracking permission

## Dev Notes

### Architecture Context
This story integrates AdMob for rewarded video ads as a core monetization strategy, following the external API specifications.

**AdMob Integration Pattern:**
- Purpose: Rewarded video ads for continue gameplay and power-ups [Source: architecture/external-apis.md#admob-api]
- SDK handles all network calls internally [Source: architecture/external-apis.md#integration-notes]
- Authentication via AdMob App ID and Ad Unit IDs [Source: architecture/external-apis.md#authentication]
- Standard AdMob quotas with unlimited usage for most cases [Source: architecture/external-apis.md#rate-limits]

**External Service Setup:**
- Requires Google account and Apple Developer Program enrollment [Source: architecture/setup-external-services.md#prerequisites]
- Test Rewarded Video Unit: `ca-app-pub-3940256099942544/1712485313` [Source: architecture/setup-external-services.md#configure-test-devices]
- iOS 18.6.2 requires ATT prompt before ad personalization [Source: architecture/setup-external-services.md#app-tracking-transparency-setup]

**Technical Constraints:**
- Must not block 60fps gameplay performance [Source: architecture/introduction.md#performance-requirements]
- Background loading to maintain user experience [Source: prd/epic-1-foundation-core-gameplay-infrastructure.md#acceptance-criteria]
- Player-controlled monetization (never forced ads) [Source: architecture/introduction.md#player-controlled-monetization]

### File Locations
- AdMob configuration: `BlockPuzzlePro/AdMobConfig.swift`
- Ad Manager: `BlockPuzzlePro/AdManager.swift`
- Info.plist: Add AdMob App ID and ATT usage description
- Build configurations: Set up dev/production ad unit switching

### AdMob Configuration Details
```swift
// Development Configuration
static let testAppID = "ca-app-pub-3940256099942544~1458002511"
static let testRewardedAdUnitID = "ca-app-pub-3940256099942544/1712485313"

// Production Configuration (to be configured later)
static let productionAppID = "YOUR_PRODUCTION_APP_ID"
static let productionRewardedAdUnitID = "YOUR_PRODUCTION_REWARDED_UNIT_ID"
```

**Required Info.plist Additions:**
- `GADApplicationIdentifier`: AdMob App ID
- `NSUserTrackingUsageDescription`: ATT permission description
- Network security configurations if needed

### Technical Implementation Notes
- Initialize AdMob SDK in AppDelegate/App struct during launch
- Use async/await pattern for ad loading to prevent blocking
- Implement proper error handling for all ad operations
- Follow Apple's ATT guidelines for permission requests
- Ensure compliance with both Apple and Google advertising policies

### Testing Requirements
- Test on both iPhone and iPad simulators
- Verify ad loading works with test units
- Test network failure scenarios
- Validate ATT permission flow
- Confirm no impact on game performance during ad operations

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-01-15 | 1.0 | Initial story creation | Bob (SM) |

## Dev Agent Record
*This section will be populated by the development agent during implementation*

### Agent Model Used
*To be filled by dev agent*

### Debug Log References
*To be filled by dev agent*

### Completion Notes List
*To be filled by dev agent*

### File List
*To be filled by dev agent*

## QA Results
*Results from QA Agent review will be populated here after implementation*