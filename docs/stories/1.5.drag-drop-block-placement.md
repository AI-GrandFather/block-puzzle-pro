# Story 1.5: Drag-and-Drop Block Placement

## Status
Draft

## Story
**As a** player,
**I want** to drag blocks from the tray and place them on the grid,
**so that** I can start playing the core puzzle game.

## Acceptance Criteria
1. Blocks can be dragged from bottom tray with smooth touch response
2. Dragged blocks follow finger movement with appropriate visual feedback
3. Valid placement positions highlight on grid during drag operations
4. Invalid placements are clearly indicated and prevent block placement
5. Successfully placed blocks snap to grid positions with satisfying animation
6. Placed blocks become part of the grid and cannot be moved

## Tasks / Subtasks
- [ ] Task 1: Drag Gesture Implementation (AC: 1)
  - [ ] Implement touch-based drag gesture recognition
  - [ ] Create draggable block view components
  - [ ] Ensure smooth touch response with minimal latency
  - [ ] Handle touch events across different device types
  - [ ] Test drag responsiveness on actual devices
- [ ] Task 2: Visual Drag Feedback (AC: 2)
  - [ ] Create floating block representation during drag
  - [ ] Implement block following finger movement
  - [ ] Add visual lift effect when drag begins
  - [ ] Ensure dragged block stays visible during movement
  - [ ] Optimize drag animation for 60fps performance
- [ ] Task 3: Valid Placement Highlighting (AC: 3)
  - [ ] Implement collision detection for block placement
  - [ ] Highlight valid grid positions during drag
  - [ ] Show placement preview on valid positions
  - [ ] Update highlights in real-time as drag moves
  - [ ] Clear highlights when drag ends
- [ ] Task 4: Invalid Placement Handling (AC: 4)
  - [ ] Detect invalid placement attempts
  - [ ] Provide visual feedback for invalid positions
  - [ ] Prevent placement in occupied or out-of-bounds areas
  - [ ] Return block to tray on invalid drop
  - [ ] Add subtle feedback for invalid placement attempts
- [ ] Task 5: Block Placement Animation (AC: 5)
  - [ ] Implement smooth snap-to-grid animation
  - [ ] Add satisfying placement completion effect
  - [ ] Ensure animation feels responsive and polished
  - [ ] Handle animation timing for different block types
  - [ ] Test placement animations across device types
- [ ] Task 6: Grid Integration (AC: 6)
  - [ ] Update grid state when blocks are placed
  - [ ] Make placed blocks immutable part of grid
  - [ ] Integrate with GameEngine for state management
  - [ ] Update visual grid representation
  - [ ] Ensure proper cleanup of drag states

## Dev Notes

### Architecture Context
This story implements core drag-and-drop interaction using SwiftUI gestures and SpriteKit integration.

**Component Integration:**
- GameEngine Component: Block placement validation and grid state management [Source: architecture/components.md#gameengine-component]
- GameView Component: Touch gesture recognition and SwiftUI interface [Source: architecture/components.md#gameview-component]
- Direct manipulation interaction paradigm [Source: prd/user-interface-design-goals.md#key-interaction-paradigms]

**Performance Requirements:**
- Maintain 60fps during drag operations [Source: architecture/introduction.md#performance-requirements]
- Smooth touch response for natural feel [Source: prd/user-interface-design-goals.md#overall-ux-vision]
- Responsive interaction without blocking [Source: prd/user-interface-design-goals.md#key-interaction-paradigms]

### File Locations
- Drag Controller: `BlockPuzzlePro/Input/DragController.swift`
- Placement Logic: `BlockPuzzlePro/Game/PlacementEngine.swift`
- Gesture Views: `BlockPuzzlePro/Views/DraggableBlockView.swift`
- Animation System: `BlockPuzzlePro/Animation/PlacementAnimator.swift`

### Drag Implementation Details
**Gesture Handling:**
```swift
@GestureState private var dragOffset = CGSize.zero
@State private var isDragging = false

var dragGesture: some Gesture {
    DragGesture(coordinateSpace: .global)
        .updating($dragOffset) { value, state, _ in
            state = value.translation
            isDragging = true
        }
        .onEnded { value in
            handleDrop(at: value.location)
        }
}
```

**Placement Validation:**
- Check grid boundaries (0-9 x 0-9)
- Verify no collision with existing blocks
- Validate complete block pattern fits
- Return validation result with feedback type

**Visual Feedback System:**
- Valid placement: Subtle green overlay on target cells
- Invalid placement: No special highlighting (clean aesthetic)
- Drag preview: Semi-transparent block at current position
- Placement animation: Smooth snap with brief highlight

### GameEngine Integration
```swift
// In GameEngine Actor
func placeBlock(blockType: BlockType, position: GridPosition) -> PlacementResult {
    // Validate placement
    guard isValidPlacement(blockType, at: position) else {
        return .invalid
    }
    
    // Update grid state
    applyBlockToGrid(blockType, at: position)
    
    return .success
}
```

### Animation Specifications
- Drag lift: 0.15s ease-out with scale(1.1) and shadow
- Drop snap: 0.25s spring animation to grid position
- Invalid return: 0.3s ease-in-out back to tray
- Placement complete: 0.1s brief highlight flash

### Performance Considerations
- Use efficient hit testing for grid position detection
- Implement touch prediction for smooth following
- Optimize redraw regions during drag operations
- Cache placement validation results when possible

### Accessibility Requirements
- VoiceOver support for drag operations
- Alternative placement method for users with motor difficulties
- Clear audio feedback for placement success/failure
- Haptic feedback for placement confirmation

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-01-15 | 1.0 | Initial story creation | Bob (SM) |

## Dev Agent Record
*This section will be populated by the development agent during implementation*

## QA Results
*Results from QA Agent review will be populated here after implementation*