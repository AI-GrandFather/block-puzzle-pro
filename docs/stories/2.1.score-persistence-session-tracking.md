# Story 2.1: Score Persistence and Session Tracking

## Status
Draft

## Story
**As a** player,
**I want** my scores to be saved locally on my device,
**so that** I can track my best performances across multiple play sessions.

## Acceptance Criteria
1. SwiftData integration with VersionedSchema V1 stores high scores locally with automatic persistence
2. Schema migration plan supports future model evolution with lightweight migration for common changes
3. High score display shows personal best prominently with real-time updates during gameplay
4. Score data persists across app launches with <2 second restoration time on app startup
5. CloudKit sync enables cross-device score sharing with conflict resolution for concurrent updates
6. Local backup export creates JSON files with schema version metadata for manual restoration scenarios
7. Data integrity validation runs automatically with corruption detection and recovery mechanisms
8. Migration testing covers upgrade paths from initial release through all subsequent versions

## Tasks / Subtasks
- [ ] Task 1: SwiftData Model Setup (AC: 1, 2)
  - [ ] Create SwiftData models for score storage
  - [ ] Implement VersionedSchema V1 for future migration support
  - [ ] Set up automatic persistence configuration
  - [ ] Create migration plan documentation
- [ ] Task 2: High Score Display (AC: 3)
  - [ ] Design high score UI component
  - [ ] Implement real-time score updates during gameplay
  - [ ] Show personal best prominently in interface
- [ ] Task 3: CloudKit Integration (AC: 5)
  - [ ] Enable CloudKit sync for SwiftData models
  - [ ] Implement conflict resolution for concurrent updates
  - [ ] Test cross-device score synchronization
- [ ] Task 4: Data Integrity & Backup (AC: 6, 7)
  - [ ] Create local JSON backup export system
  - [ ] Implement automatic data integrity validation
  - [ ] Add corruption detection and recovery mechanisms
- [ ] Task 5: Performance & Migration Testing (AC: 4, 8)
  - [ ] Ensure <2 second restoration time on app startup
  - [ ] Test migration paths between schema versions

## Dev Notes

### Architecture Context
Implements persistent storage using SwiftData with CloudKit integration as specified in the tech stack.

**Technology Stack:**
- Database: SwiftData (iOS 17+) for local storage [Source: architecture/tech-stack.md#technology-stack-table]
- File Storage: CloudKit (Free Tier) for score sync [Source: architecture/tech-stack.md#technology-stack-table]
- ScoreTracker Component: Integration with SwiftData persistence [Source: architecture/components.md#scoretracker-component]

**Performance Requirements:**
- <2 second restoration time aligns with launch performance targets [Source: architecture/introduction.md#performance-requirements]
- Automatic CloudKit sync for cross-device experience [Source: architecture/external-apis.md#cloudkit-api]

### File Locations
- Score Model: `BlockPuzzlePro/Models/ScoreModel.swift`
- Persistence Manager: `BlockPuzzlePro/Data/PersistenceManager.swift`
- CloudKit Sync: `BlockPuzzlePro/Data/CloudKitManager.swift`
- Backup System: `BlockPuzzlePro/Data/BackupManager.swift`

### SwiftData Model Implementation
```swift
@Model
final class GameScore {
    var score: Int
    var timestamp: Date
    var gameMode: String
    var version: String
    
    init(score: Int, gameMode: String = "endless") {
        self.score = score
        self.timestamp = Date()
        self.gameMode = gameMode
        self.version = "1.0"
    }
}

// VersionedSchema for migration support
enum GameScoreSchema: VersionedSchema {
    static var versionIdentifier = Schema.Version(1, 0, 0)
    
    static var models: [any PersistentModel.Type] {
        [GameScore.self]
    }
}
```

### CloudKit Integration Notes
- Automatic SwiftData + CloudKit integration [Source: architecture/external-apis.md#integration-notes]
- Conflict resolution handles concurrent score updates
- Background sync operations don't interfere with gameplay

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-01-15 | 1.0 | Initial story creation | Bob (SM) |

## Dev Agent Record
*This section will be populated by the development agent during implementation*

## QA Results
*Results from QA Agent review will be populated here after implementation*